<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF Grid</title>
<style>
body { font-family:sans-serif; margin:0; background:#111; color:#fff; }
.grid { display:grid; gap:20px; padding:20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
.grid-item { cursor:pointer; text-align:center; }
.grid-item img { width:100%; height:auto; border:2px solid #fff; }
.title { margin-top:5px; font-size:0.9em; word-wrap:break-word; }
.overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:999; flex-direction: column; overflow:auto; }
.close { position:absolute; top:20px; right:30px; font-size:2em; cursor:pointer; color:#fff; }
.pdf-container { width:90%; height:90%; overflow:auto; }
canvas { display:block; margin:auto; background:#333; }
</style>
</head>
<body>

<div class="grid" id="pdfGrid"></div>

<div class="overlay" id="overlay">
  <span class="close" onclick="closeOverlay()">&times;</span>
  <div class="pdf-container">
    <canvas id="pdfCanvas"></canvas>
  </div>
</div>

<script type="module">
import * as pdfjsLib from './pdfjs/pdf.mjs';

const username = "rachelpearlstuart-eng";
const repo = "poetry";
const branch = "main";
const baseRaw = `https://raw.githubusercontent.com/${username}/${repo}/${branch}/`;

const pdfFiles = [
  { pdf: "01 - SUPPOSE MISCHIEF (2025, FEBRUARY)-compressed.pdf", thumb: "01 - SUPPOSE MISCHIEF (2025, FEBRUARY)-compressed.png" },
  { pdf: "02 - PRETEND (2025, JUNE)-compressed.pdf", thumb: "02 - PRETEND (2025, JUNE)-compressed.png" },
  { pdf: "03 - CONE CAN (2025, AUGUST)-compressed.pdf", thumb: "03 - CONE CAN (2025, AUGUST)-compressed.png" }
];

const grid = document.getElementById("pdfGrid");
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');
let pdfDoc = null;

// Helper: fetch file as Blob and return object URL
async function fetchBlobUrl(path) {
    const response = await fetch(baseRaw + path);
    if (!response.ok) throw new Error("Failed to fetch " + path);
    const blob = await response.blob();
    return URL.createObjectURL(blob);
}

// Build grid with thumbnails
pdfFiles.forEach(async file => {
    const item = document.createElement("div");
    item.className = "grid-item";
    try {
        const thumbUrl = await fetchBlobUrl(encodeURIComponent(file.thumb));
        item.innerHTML = `
            <img src="${thumbUrl}" alt="${file.pdf}">
            <div class="title">${file.pdf}</div>
        `;
        item.onclick = async () => {
            const pdfUrl = await fetchBlobUrl(encodeURIComponent(file.pdf));
            openOverlay(pdfUrl);
        };
        grid.appendChild(item);
    } catch (err) {
        console.error("Error loading thumbnail", file.thumb, err);
        item.innerHTML = `<div class="title">Failed to load thumbnail: ${file.pdf}</div>`;
        grid.appendChild(item);
    }
});

// Render PDF page
function renderPage(num) {
    pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale: 2 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        page.render({ canvasContext: ctx, viewport: viewport });
    });
}

// Open overlay and render PDF
async function openOverlay(pdfUrl) {
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    try {
        const response = await fetch(pdfUrl);
        if (!response.ok) throw new Error("Failed to fetch PDF");
        const pdfData = await response.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
        renderPage(1);
    } catch (err) {
        console.error("Error loading PDF", err);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.font = "20px sans-serif";
        ctx.fillText("Failed to load PDF", 50, 50);
    }
}

function closeOverlay() {
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'none';
    pdfDoc = null;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

window.openOverlay = openOverlay;
window.closeOverlay = closeOverlay;

</script>
</body>
</html>
