<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF Grid</title>
<style>
body { font-family: sans-serif; margin:0; background:#111; color:#fff; }
.grid { display:grid; gap:20px; padding:20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
.grid-item { cursor:pointer; text-align:center; }
.grid-item img { width:100%; height:auto; border:2px solid #fff; }
.title { margin-top:5px; font-size:0.9em; word-wrap:break-word; }
.overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:999; flex-direction: column; }
.close { position:absolute; top:20px; right:30px; font-size:2em; cursor:pointer; color:#fff; }
.pdf-container { width:80%; height:90%; overflow:auto; border:none; }
canvas { display:block; margin:auto; }
</style>
</head>
<body>

<div class="grid" id="pdfGrid">
  <!-- PDF thumbnails will be injected here -->
</div>

<div class="overlay" id="overlay">
  <span class="close" onclick="closeOverlay()">&times;</span>
  <div class="pdf-container">
    <canvas id="pdfCanvas"></canvas>
  </div>
</div>

<script type="module">
import * as pdfjsLib from './pdfjs/pdf.mjs';

const username = "rachelpearlstuart-eng";
const repo = "poetry";
const branch = "main";
const baseRaw = `https://raw.githubusercontent.com/${username}/${repo}/${branch}/`;

const grid = document.getElementById("pdfGrid");

async function fetchRepoFiles() {
    const api = `https://api.github.com/repos/${username}/${repo}/contents/`;
    const res = await fetch(api);
    const files = await res.json();

    const pdfs = files.filter(f => f.name.toLowerCase().endsWith(".pdf"));
    const pngs = {};
    files.filter(f => f.name.toLowerCase().endsWith(".png")).forEach(f => pngs[f.name.toLowerCase()] = f.name);

    pdfs.forEach(pdf => {
        const name = pdf.name.split(".")[0];
        const thumb = pngs[(name + ".png").toLowerCase()] || "default.png";

        const item = document.createElement("div");
        item.className = "grid-item";
        item.innerHTML = `
            <img src="${baseRaw + thumb}" alt="${pdf.name}">
            <div class="title">${pdf.name}</div>
        `;
        item.onclick = () => openOverlay(baseRaw + pdf.name);
        grid.appendChild(item);
    });
}

let pdfDoc = null;
let pageNum = 1;
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');

function renderPage(num) {
    pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        const renderCtx = { canvasContext: ctx, viewport: viewport };
        page.render(renderCtx);
    });
}

export function openOverlay(pdfUrl) {
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
        pdfDoc = pdf;
        pageNum = 1;
        renderPage(pageNum);
    });
}

function closeOverlay() {
    document.getElementById('overlay').style.display = 'none';
    pdfDoc = null;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

window.openOverlay = openOverlay;
window.closeOverlay = closeOverlay;

fetchRepoFiles();
</script>

</body>
</html>
